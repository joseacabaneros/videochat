function AudioManagement(e,n){function t(n){e.send(JSON.stringify({section:"audio",data:{url:n}}))}var a=!1,o=document.getElementById("audioId"),i=document.getElementById("audioSource");i.onerror=function(){n.error("The URL provided is not a valid audio",{title:"Error"})},this.setMuted=function(e){a=e},this.isMuted=function(){return a},this.playAudio=function(e){t(e)},this.updateAudioUrl=function(e){a||(i.src=e,o.load(),o.play())}}function DashvideoManagement(){var e,n,t;e=document.getElementById("dashvideoId"),n=new Webm.di.WebmContext,t=new MediaPlayer(n),t.startup(),t.attachView(e),t.setAutoPlay(!0),t.attachSource(config.dashUrl)}function DrawingManagement(e){function n(n,t,a){e.send(JSON.stringify({section:"drawings",data:{operation:a,type:n,info:t}}))}var t=new fabric.Canvas("canvas");t.setHeight(350),t.setWidth(350),t.freeDrawingBrush.color="green",t.freeDrawingBrush.lineWidth=10,this.addCircle=function(){n("Circle",{radius:20,fill:"green",left:100,top:100},"add")},this.addRectangle=function(){n("Rectangle",{top:100,left:100,width:60,height:70,fill:"red"},"add")},this.addTriangle=function(){n("Triangle",{width:20,height:30,fill:"blue",left:50,top:50},"add")},this.getPencil=function(){t.isDrawingMode=!0},this.getSelection=function(){t.isDrawingMode=!1},this.clearAll=function(e,t){n("","","clearAll")},this.addObject=function(e,n){var a;"Triangle"==e?a=new fabric.Triangle(n):"Rectangle"==e?a=new fabric.Rect(n):"Circle"==e&&(a=new fabric.Circle(n)),t.add(a)},this.clearObjects=function(e,n){t.clear()}}function GeolocationManagement(e,n){function t(e){latitude=e.coords.latitude,longitude=e.coords.longitude,i==latitude&&r==longitude||(l.setDisconnected(),l.setConnected(latitude,longitude),i=latitude,r=longitude)}function a(e){n.error("Error trying to get the geolocation of the user",{title:"Error"})}function o(n,t,a,o,i){e.send(JSON.stringify({section:"geolocation",data:{operation:i,name:o,userName:a,latitude:n,longitude:t}}))}var i,r,s,c,d=[],l=this,u=new google.maps.LatLng(43.383,-5.824);"geolocation"in navigator?(s=new google.maps.Map(document.getElementById("map"),{center:u,zoom:3}),navigator.geolocation.watchPosition(t,a)):n.error("The browser is not compatible with the Geolocation HTML5 API",{title:"Error"}),this.addMarker=function(e){var n=new google.maps.Marker({position:{lat:e.latitude,lng:e.longitude},icon:"images/funchat.png",animation:google.maps.Animation.DROP,draggable:!0,map:s}),t={marker:n,userName:e.userName};d.push(t);var a=new google.maps.InfoWindow({content:e.name});n.addListener("click",function(){a.open(s,n)})},this.setUser=function(e,n){c={userName:e,name:n}},this.deleteMarker=function(e){for(var n=0;n<d.length;n++)d[n].userName==e.userName&&(d[n].marker.setMap(null),d.splice(n,1),n--)},this.setConnected=function(e,n){l.addMarker({name:c.name,userName:c.userName,latitude:e,longitude:n}),o(e,n,c.userName,c.name,"connected")},this.setDisconnected=function(){l.deleteMarker({userName:c.userName}),o("","",c.userName,c.name,"disconnected")}}function MessagesManagement(e,n){function t(n){e.send(JSON.stringify({section:"messages",data:{operation:"text",name:o.name,userName:o.userName,text:n}}))}var a={};a.loading=[!0],a.list=[];var o;this.setUser=function(e,n){o={userName:e,name:n}},this.addMessage=function(e){a.list.unshift(e)},this.setLoading=function(e){a.loading[0]=e},this.getMessages=function(){return a.list},this.isLoading=function(){return a.loading},this.sendMessage=function(e){t(e)},this.showError=function(e){n.error(e,{title:"Error"})},this.sendFile=function(n,t){var a=new FileReader;a.onloadend=function(){e.send(JSON.stringify({section:"messages",data:{operation:t,name:o.name,userName:o.userName,binary:a.result,name:n.name}}))},a.readAsDataURL(n)}}function PeopleManagement(e,n){function t(n,t,a){e.send(JSON.stringify({section:"people",data:{operation:a,name:t,userName:n}}))}var a={};a.loading=[!0],a.list=[];var o;this.addPerson=function(e){a.list.push(e),o.userName!=e.userName&&n.info("User connected: "+e.name,{title:"Info"})},this.getPeople=function(){return a.list},this.deletePerson=function(e){for(var t=0;t<a.list.length;t++)a.list[t].userName==e.userName&&(n.info("User disconnected: "+e.name,{title:"Info"}),a.list.splice(t,1),t--)},this.setLoading=function(e){a.loading[0]=e},this.isLoading=function(){return a.loading},this.setConnected=function(e,n){o={userName:e,name:n},this.addPerson(o),t(e,n,"connected")},this.setDisconnected=function(){this.deletePerson(o),t(o.userName,o.name,"disconnected")}}function PresentationManagement(e,n){function t(e){a(e.indexh,e.indexv)}function a(n,t){e.send(JSON.stringify({section:"presentation",data:{indexh:n,indexv:t,userName:i.userName}}))}var o,i,r=document.getElementById("iframe");r.onload=function(){o=r.contentWindow.Reveal,o.addEventListener("slidechanged",t)},this.updateSlide=function(e){o.removeEventListener("slidechanged",t),o.slide(e.indexh,e.indexv),o.addEventListener("slidechanged",t)},this.setUser=function(e,n){i={userName:e,name:n}}}function RadioManagement(e,n){document.getElementById("radioId");document.getElementById("radioSource").onerror=function(){n.error("The URL provided is not a valid radio",{title:"Error"})}}function StreamingManagement(e,n){document.getElementById("streamingId");document.getElementById("streamingSource").onerror=function(){n.error("The URL provided is not a valid non-adaptative streaming video",{title:"Error"})}}function VideoconferenceManagement(e,n){function t(){w.width=b.offsetWidth/2.1,w.height=b.offsetWidth/2.1,A.forEach(function(e){e.video.width=b.offsetWidth/2.1,e.video.height=b.offsetWidth/2.1})}function a(){navigator.mediaDevices.getUserMedia(v).then(o).catch(i)}function o(e){M=e,w.src=window.URL.createObjectURL(e),w.play(),w.muted=!0,g("login")}function i(e){w.setAttribute("poster","images/videoconference.png"),n.error("The videoconference is not available",{title:"Error"})}function r(){"undefined"==typeof RTCPeerConnection&&(RTCPeerConnection=webkitRTCPeerConnection);var e,e={iceServers:[{urls:"turn:numb.viagenie.ca:3478",username:"uo234549@uniovi.es",credential:"joseantonio"}]},n=new RTCPeerConnection(e);return n.addStream(M),n.onicecandidate=function(e){e.candidate&&f(e.candidate,s(n))},n.onaddstream=function(e){var a=document.createElement("VIDEO");a.src=window.URL.createObjectURL(e.stream),a.className="videoRemote",a.play(),a.muted=!1,A.push({userName:s(n),video:a}),t(),b.appendChild(a)},n}function s(e){for(var n=0;n<x.length;n++)if(x[n].connection==e)return x[n].userName}function c(e,n){var t=r();x.push({userName:n,connection:t}),t.setRemoteDescription(new RTCSessionDescription(e)),t.createAnswer(function(e){t.setLocalDescription(e),p(e,n)},function(e){console.error(e)})}function d(e,n){x.forEach(function(t){t.userName==n&&t.connection.setRemoteDescription(new RTCSessionDescription(e))})}function l(e,n){x.forEach(function(t){t.userName==n&&t.connection.addIceCandidate(new RTCIceCandidate(e))})}function u(e){for(var n=0;n<x.length;n++)x[n].userName==e&&(x[n].connection.close(),x.splice(n,1),n--);for(var n=0;n<A.length;n++)A[n].userName==e&&(b.removeChild(A[n].video),A.splice(n,1),n--)}function g(n){e.send(JSON.stringify({section:"videoconference",data:{operation:n,userName:h.userName}}))}function m(n,t){e.send(JSON.stringify({section:"videoconference",data:{operation:"offer",sourceUserName:h.userName,targetUserName:t,offer:n}}))}function p(n,t){e.send(JSON.stringify({section:"videoconference",data:{operation:"answer",sourceUserName:t,targetUserName:h.userName,answer:n}}))}function f(n,t){e.send(JSON.stringify({section:"videoconference",data:{operation:"candidate",userName:h.userName,otherUserName:t,candidate:n}}))}var h,M,v={audio:!0,video:!0},w=document.getElementById("videoconferenceLocal"),b=document.getElementById("videoconferenceArea"),N=[!0,!0],y=!1,S=!1,x=[],A=[];a(),w.onloadeddata=function(){N[1]=!1,t()},window.onresize=function(){t()},this.setUser=function(e,n){h={userName:e,name:n}},this.setMuted=function(e){y=e,M.getAudioTracks()[0].enabled=!y,A.forEach(function(n){n.video.muted=e})},this.isMuted=function(){return y},this.setDisabled=function(e){S=e,S?null!=M&&(w.pause(),M.getTracks().forEach(function(e){e.stop()}),this.setDisconnected(),n.info("The videoconference has been disabled",{title:"Info"})):(a(),n.info("The videoconference has been enabled",{title:"Info"}))},this.isDisabled=function(){return S},this.setLoading=function(e){N[0]=e},this.isLoading=function(){return N},this.getMessage=function(e){switch(e.operation){case"login":e.others.forEach(function(e){var n=r();n.createOffer(function(t){m(t,e),n.setLocalDescription(t)},function(e){console.err("Failed to create signaling message: "+e.message)}),x.push({userName:e,connection:n})});break;case"offer":c(e.offer,e.sourceUserName);break;case"answer":d(e.answer,e.targetUserName);break;case"candidate":l(e.candidate,e.userName);break;case"leave":u(e.userName)}},this.setDisconnected=function(){g("leave");for(var e=0;e<x.length;e++)x[e].connection.close(),x.splice(e,1),e--;for(var e=0;e<A.length;e++)b.removeChild(A[e].video),A.splice(e,1),e--}}function VideoManagement(e,n){function t(n){e.send(JSON.stringify({section:"video",data:{url:n}}))}var a=!1,o=document.getElementById("videoId"),i=document.getElementById("videoSource");i.onerror=function(){n.error("The URL provided is not a valid video",{title:"Error"})},this.setMuted=function(e){a=e},this.isMuted=function(){return a},this.playVideo=function(e){t(e)},this.updateVideoUrl=function(e){a||(i.src=e,o.load(),o.play())}}angular.module("multichatApp").controller("audioCtrl",["$scope","webSocketManager","$uibModal",function(e,n,t){e.muteAudioModel=n.audioManagement.isMuted(),e.changeMuteAudioModel=function(){n.audioManagement.setMuted(e.muteAudioModel)},e.showAudioModal=function(e,a,o,i){var r={selectAudio:e,url:a,accept:o,cancel:i};t.open({templateUrl:"templates/audioUrlModal.html",controller:"audioModalCtrl",resolve:{data:function(){return r}}}).result.then(function(e){n.audioManagement.playAudio(e)})}}]),angular.module("multichatApp").controller("audioModalCtrl",["$scope","$uibModalInstance","data",function(e,n,t){e.data=t,e.close=function(e){n.dismiss("cancel")},e.accept=function(t){t=e.url,n.close(t)}}]),angular.module("multichatApp").controller("drawingCtrl",["$scope","webSocketManager",function(e,n){e.addCircle=function(){n.drawingManagement.addCircle()},e.addRectangle=function(){n.drawingManagement.addRectangle()},e.addTriangle=function(){n.drawingManagement.addTriangle()},e.getPencil=function(){n.drawingManagement.getPencil()},e.getSelection=function(){n.drawingManagement.getSelection()},e.clearAll=function(){n.drawingManagement.clearAll()}}]),angular.module("multichatApp").controller("geolocationCtrl",["$scope","webSocketManager",function(e,n){var t=e.sub.split("%");n.geolocationManagement.setUser(t[0],t[1])}]),angular.module("multichatApp").controller("loginCtrl",["$scope","$http","$window","$cookies",function(e,n,t,a){function o(n){e.data.errorShow=!1,e.data.userNotValid=!1,a.put("token",n.data.token),"undefined"!=e.redirect?t.location.href=e.redirect:t.location.href="/multichat"}function i(n){401==n.status?e.data.userNotValid=!0:(e.data.error=n.statusText+" ("+n.status+")",e.data.errorShow=!0)}e.data={},e.data.errorShow=!1,e.data.userNotValid=!1,e.submit=function(e){console.log(e),n({method:"POST",url:"/api/login",data:angular.toJson(e),headers:{"Content-Type":"application/json"}}).then(o,i)}}]),angular.module("multichatApp").controller("logoutCtrl",["$cookies",function(e){e.remove("token")}]),angular.module("multichatApp").controller("messagesCtrl",["$scope","webSocketManager","$uibModal",function(e,n,t){var a=e.sub.split("%");n.messagesManagement.setUser(a[0],a[1]),e.userName=a[0],e.data={},e.data.loading=n.messagesManagement.isLoading(),e.data.messages=n.messagesManagement.getMessages(),e.comment="",e.commentSent=function(){n.messagesManagement.sendMessage(e.comment),e.comment=""},e.checkEnter=function(t){13==t.keyCode&&(n.messagesManagement.sendMessage(e.comment),e.comment="")},e.iconSent=function(n){e.comment+=n},e.showAllEmojis=function(){e.showEmojis=!e.showEmojis},e.showFileModal=function(e,a,o,i){t.open({templateUrl:"templates/messageFileModal.html",controller:"messagesFileModalCtrl"}).result.then(function(e){if("Too big"==e)n.messagesManagement.showError("The file cannot be sent because it exceeds the maximum allowed size");else switch(e.type){case"image/png":case"image/gif":case"image/jpeg":n.messagesManagement.sendFile(e,"picture");break;default:n.messagesManagement.sendFile(e,"attached")}})},e.showPictureOpenModal=function(e){var n={picture:e};t.open({templateUrl:"templates/messagePictureOpenModal.html",controller:"messagesPictureOpenModalCtrl",size:"lg",resolve:{data:function(){return n}}})}}]),angular.module("multichatApp").controller("messagesFileModalCtrl",["$scope","$uibModalInstance",function(e,n){Dropzone.autoDiscover=!1,e.dzCallbacks={addedfile:function(e){e.size<config.maxSizeAttachment?n.close(e):n.close("Too big")}}}]),angular.module("multichatApp").controller("messagesPictureOpenModalCtrl",["$scope","$uibModalInstance","data",function(e,n,t){e.data=t}]),angular.module("multichatApp").controller("peopleCtrl",["$scope","webSocketManager",function(e,n){var t=e.sub.split("%");n.peopleManagement.setConnected(t[0],t[1]),e.data={},e.data.loading=n.peopleManagement.isLoading(),e.data.people=n.peopleManagement.getPeople()}]),angular.module("multichatApp").controller("presentationCtrl",["$scope","webSocketManager",function(e,n){var t=e.sub.split("%");n.presentationManagement.setUser(t[0],t[1])}]),angular.module("multichatApp").controller("profileCtrl",["$scope","$http","$window","$cookies",function(e,n,t,a){function o(n){e.data.errorShow=!1,e.data.okShow=!0,a.put("token",n.data.token)}function i(e){a.remove("token"),t.location.href="/index"}function r(n){e.data.error=n.statusText+" ("+n.status+")",e.data.errorShow=!0,e.data.okShow=!1}e.data={},e.data.errorShow=!1,e.data.okShow=!1,e.submit=function(e){n({method:"PUT",url:"/api/profile",data:angular.toJson(e),headers:{"Content-Type":"application/json"}}).then(o,r)},e.submitDelete=function(e){n({method:"DELETE",url:"/api/delete/"+e.userName,headers:{"Content-Type":"application/json"}}).then(i,r)}}]),angular.module("multichatApp").controller("registerCtrl",["$scope","$http","$window","$cookies",function(e,n,t,a){function o(n){e.data.errorShow=!1,a.put("token",n.data.token),t.location.href="/multichat"}function i(n){e.data.error=n.statusText+" ("+n.status+")",e.data.errorShow=!0}e.data={},e.data.errorShow=!1,e.submit=function(e){n({method:"POST",url:"/api/register",data:angular.toJson(e),headers:{"Content-Type":"application/json"}}).then(o,i)}}]),angular.module("multichatApp").controller("videoconferenceCtrl",["$scope","webSocketManager",function(e,n){e.data={},e.data.loading=n.videoconferenceManagement.isLoading();var t=e.sub.split("%");n.videoconferenceManagement.setUser(t[0],t[1]),e.disableVideoconferenceModel=n.videoconferenceManagement.isDisabled(),e.changeDisableVideoconferenceModel=function(){n.videoconferenceManagement.setDisabled(e.disableVideoconferenceModel)},e.muteVideoconferenceModel=n.videoconferenceManagement.isMuted(),e.changeMuteVideoconferenceModel=function(){n.videoconferenceManagement.setMuted(e.muteVideoconferenceModel)}}]),angular.module("multichatApp").controller("videoCtrl",["$scope","webSocketManager","$uibModal",function(e,n,t){e.muteVideoModel=n.videoManagement.isMuted(),e.changeMuteVideoModel=function(){n.videoManagement.setMuted(e.muteVideoModel)},e.showVideoModal=function(e,a,o,i){var r={selectVideo:e,url:a,accept:o,cancel:i};t.open({templateUrl:"templates/videoUrlModal.html",controller:"videoModalCtrl",resolve:{data:function(){return r}}}).result.then(function(e){n.videoManagement.playVideo(e)})}}]),angular.module("multichatApp").controller("videoModalCtrl",["$scope","$uibModalInstance","data",function(e,n,t){e.data=t,e.close=function(e){n.dismiss("cancel")},e.accept=function(t){t=e.url,n.close(t)}}]),angular.module("multichatApp").directive("compareTo",function(){return{restrict:"A",require:"ngModel",scope:{elementToCompare:"=compareTo"},link:function(e,n,t,a){a.$validators.compareTo=function(n){return n==e.elementToCompare},e.$watch("elementToCompare",function(){a.$validate()})}}}),angular.module("multichatApp").directive("userNameAvailable",["$http","$q",function(e,n){return{restrict:"A",require:"ngModel",link:function(t,a,o,i){i.$asyncValidators.userNameAvailable=function(a){function o(e){t.data.errorShow=!1,e.data.length>0?(i.$setValidity("userNameAvailable",!1),s.reject("Username has already been taken")):(i.$setValidity("userNameAvailable",!0),s.resolve())}function r(e){t.data.error=e.statusText+" ("+e.status+")",t.data.errorShow=!0,i.$setValidity("userNameAvailable",!1),s.reject("An error has been occurred")}var s=n.defer();return e.get("api/users/"+a,{headers:{"Content-Type":"application/json"}}).then(o,r),s.promise}}}}]),angular.module("multichatApp").filter("emojis",["$sce",function(e){return function(n){var t=n.replace(/ /g,"&nbsp;");return t=t.replace(/\n/g,"<br>"),t=t.replace(/:D/g,'<img src="images/emojis/smiley-01.png" width="20px" height="20px">'),t=t.replace(/:\)/g,'<img src="images/emojis/smiley-05.png" width="20px" height="20px">'),t=t.replace(/;\)/g,'<img src="images/emojis/smiley-06.png" width="20px" height="20px">'),t=t.replace(/:x/g,'<img src="images/emojis/smiley-07.png" width="20px" height="20px">'),t=t.replace(/:\*/g,'<img src="images/emojis/smiley-08.png" width="20px" height="20px">'),t=t.replace(/;-\)/g,'<img src="images/emojis/smiley-12.png" width="20px" height="20px">'),t=t.replace(/:-P/g,'<img src="images/emojis/smiley-14.png" width="20px" height="20px">'),t=t.replace(/:S/g,'<img src="images/emojis/smiley-15.png" width="20px" height="20px">'),t=t.replace(/:\(/g,'<img src="images/emojis/smiley-17.png" width="20px" height="20px">'),t=t.replace(/:o\)/g,'<img src="images/emojis/smiley-18.png" width="20px" height="20px">'),t=t.replace(/%\)/g,'<img src="images/emojis/smiley-19.png" width="20px" height="20px">'),t=t.replace(/:'\(/g,'<img src="images/emojis/smiley-22.png" width="20px" height="20px">'),t=t.replace(/:'\)/g,'<img src="images/emojis/smiley-23.png" width="20px" height="20px">'),t=t.replace(/D=%/g,'<img src="images/emojis/smiley-32.png" width="20px" height="20px">'),t=t.replace(/D:%/g,'<img src="images/emojis/smiley-33.png" width="20px" height="20px">'),t=t.replace(/:\[/g,'<img src="images/emojis/smiley-35.png" width="20px" height="20px">'),t=t.replace(/\|O\)/g,'<img src="images/emojis/smiley-41.png" width="20px" height="20px">'),t=t.replace(/:-C/g,'<img src="images/emojis/orte-59.png" width="20px" height="20px">'),t=t.replace(/:-L/g,'<img src="images/emojis/orte-15.png" width="20px" height="20px">'),t=t.replace(/:-K/g,'<img src="images/emojis/natur-09.png" width="20px" height="20px">'),e.trustAsHtml(t)}}]),angular.module("multichatApp").filter("pictures",["$sce",function(e){return function(n){var t='<img src="'+n.binary+'" width="50px" height="50px">';return t+="<p>"+n.name+"</p>",e.trustAsHtml(t)}}]),angular.module("multichatApp").service("utils",function(){function e(e){try{JSON.parse(e)}catch(e){return!1}return!0}return{isJson:e}}),angular.module("multichatApp").service("webSocketManager",["$websocket","growl","utils",function(e,n,t){window.WebSocket||(console.log("WebSockets NOT supported."),alert("Consider updating your browser for a better experience."));var a=location.origin.replace(/^http/,"ws"),o=e(a),i=new PeopleManagement(o,n),r=new MessagesManagement(o,n),s=new GeolocationManagement(o,n),c=new StreamingManagement(o,n),d=new DashvideoManagement,l=new RadioManagement(o,n),u=new VideoManagement(o,n),g=new AudioManagement(o,n),m=new VideoconferenceManagement(o,n),p=new DrawingManagement(o),f=new PresentationManagement(o,n);return o.onOpen(function(){i.setLoading(!1),r.setLoading(!1),m.setLoading(!1),n.success("Server started. Enjoy!",{title:"Success"}),setInterval(function(){o.send("ping at "+(new Date).getUTCSeconds())},3e4)}),window.onbeforeunload=function(){s.setDisconnected(),i.setDisconnected(),m.setDisconnected(),o.close()},o.onMessage(function(e){if(t.isJson(e.data)){var n=JSON.parse(e.data);switch(n.section){case"people":"connected"==n.data.operation?i.addPerson(n.data):"disconnected"==n.data.operation&&i.deletePerson(n.data);break;case"messages":r.addMessage(n.data);break;case"video":u.updateVideoUrl(n.data.url);break;case"audio":g.updateAudioUrl(n.data.url);break;case"videoconference":m.getMessage(n.data);break;case"drawings":"add"==n.data.operation?p.addObject(n.data.type,n.data.info):"clearAll"==n.data.operation&&p.clearObjects();break;case"geolocation":"connected"==n.data.operation?s.addMarker(n.data):"disconnected"==n.data.operation&&s.deleteMarker(n.data);break;case"presentation":f.updateSlide(n.data)}}}),{ws:o,peopleManagement:i,messagesManagement:r,streamingManagement:c,dashvideoManagement:d,radioManagement:l,videoManagement:u,audioManagement:g,videoconferenceManagement:m,drawingManagement:p,geolocationManagement:s,presentationManagement:f}}]),angular.module("multichatApp").config(["growlProvider",function(e){e.globalPosition("bottom-right"),e.globalTimeToLive(2e3)}]),angular.module("multichatApp").config(["dropzoneOpsProvider",function(e){e.setOptions({url:"/",dictDefaultMessage:"Drop your picture or your file to be attached. You can also click here to open the File dialog"})}]),angular.module("multichatApp").config(["$compileProvider",function(e){e.aHrefSanitizationWhitelist(/^\s*(data):/)}]);